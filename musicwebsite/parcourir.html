<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotijam</title>
    <script type="text/javascript" src="ressources/fonctions.js"></script>
    <link rel="stylesheet" href="ressources/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{
            width: 100% ;
        }
        td{
            max-width: 10%;
            text-align: left;
            text-decoration: none;  
        }
        a{
            color:white;
        }
        a:hover{
            color:grey;
            cursor: pointer;
            transition: 0.3s;
            text-decoration: none;
        }
        img:hover{
            opacity: 0.5;
            transition: 0.3s;
        }

        @media screen and (max-width: 600px){
            #recherche{
                position: fixed;
                top:341px;
                width: 100%;
                margin-right: 0%;
            }
        }

        @media screen and (min-width: 601px){
            #recherche{
                width: 16%;
                margin-right: 5%;
                top: 55px;
            }
        }
        
        #recherche{
            position: fixed;
            right: 0px;
            
            background-color: rgb(20,20,20);
            z-index: 2;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            padding-left: 10px;
            font-family: Roboto,-apple-system,BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Arial,sans-serif;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.5;
            color:rgb(220,220,220);
            padding-bottom: 5px;
            
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="position: fixed;width:100%;top:0px;z-index:1">
        <a class="navbar-brand" href="accueil.html">Spotijam</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="true" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon" id="btnmenu"></span>
        </button>
      
        <div class="navbar-collapse collapse" id="navbarColor02" style="margin-left: 3%;">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item" style="margin-left: 7%; margin-right: 7%;">
              <a class="nav-link" style="margin-right:20%" href="parcourir.html?categorie=nouveautes">Nouveautés</a>
            </li>
            <li class="nav-item" style="margin-left: 7%; margin-right: 7%;">
              <a class="nav-link" href="parcourir.html?categorie=ambient">Ambiance</a>
            </li>
            <li class="nav-item" style="margin-left: 7%; margin-right: 7%;">
                <a class="nav-link" href="parcourir.html?categorie=workout">Sport</a>
            </li>
            <li class="nav-item" style="margin-left: 7%; margin-right: 7%;">
                <a class="nav-link" href="parcourir.html?categorie=hip-hop">Rap</a>
            </li>
            <li class="nav-item" style="margin-left: 7%; margin-right: 7%;">
                <a class="nav-link" href="parcourir.html?categorie=electro">Electro</a>
            </li>
          </ul>
          <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="text" id="txtrecherche" placeholder="Rechercher un artiste">
            <button class="btn btn-secondary my-2 my-sm-0" type="submit">Rechercher</button>
          </form>
        </div>
      </nav>

      <div id="recherche" style="display: none;"></div>

<br>

<div class="container" id="container">
    <br>
          <h2 id="titre"></h2>
    <table id="tableau"></table>
</div>

</body>

<script>
    const data = null;

    const xhr = new XMLHttpRequest();
    xhr.withCredentials = true;

    var row;
    var cell;
    var i = 0;
    

    xhr.addEventListener("readystatechange", function () {
        if (this.readyState === this.DONE) {

            var releases = JSON.parse(this.responseText);
            if(categorie == "nouveautes")
            {
                var k;
                for(k=releases["albums"]["items"].length-1; k>=0; k=k-1)
                {
                    if(releases["albums"]["items"][k]["album_type"] === "album"){
                        row = tableau.insertRow(i);
                        cell = row.insertCell(i);
                        cell.innerHTML = "<a href='artiste.html?id=" + releases["albums"]["items"][k]["artists"][0]["id"] + "'><span style='font-size:20px'>&nbsp; Artiste : " + releases["albums"]["items"][k]["artists"][0]["name"] + "</a><br>";
                        cell.innerHTML += "&nbsp;&nbsp; Date de sortie : " + releases["albums"]["items"][k]["release_date"];
                        cell.innerHTML += "<br>&nbsp;&nbsp; Nombre de musiques : " + releases["albums"]["items"][k]["total_tracks"];
                        cell.innerHTML += "<br>&nbsp;&nbsp;<a style='color:rgb(130,130,130)' href='" + releases["albums"]["items"][k]["external_urls"]["spotify"] + "' target='_blank'> Ecouter sur Spotify <img src='https://i.pinimg.com/originals/2b/d4/2e/2bd42ea12995732246a3b9acdbb0f880.png' style='max-width:20px'></a>" ;
                        cell.innerHTML += "</span>";

                        if (window.matchMedia("(max-width: 600px)").matches)
                            row = tableau.insertRow(i);
                        
                        cell = row.insertCell(i);
                        if(releases["albums"]["items"][k]["name"].length > 17){
                            releases["albums"]["items"][k]["name"] = releases["albums"]["items"][k]["name"].substring(0,17) + "...";
                        }
                        cell.innerHTML = "<br><h5>" + releases["albums"]["items"][k]["name"] + "</h5>";
                        if(releases["albums"]["items"][k]["images"].length > 0)
                        console.log(releases)
                            cell.innerHTML += "<a href='artiste.html?id=" + releases["albums"]["items"][k]["artists"][0]["id"] + "'><img style='max-width:250px' src='" + releases["albums"]["items"][k]["images"][1]["url"] + "'></a>";
                    }
                }
            }
            else
            {
                var j;
                var genres;
                for(j=releases["artists"]["items"].length-1; j>=0; j=j-1)
                {
                    row = tableau.insertRow(i);
                    cell = row.insertCell(i);
                    genres = "";
                    
                    if(releases["artists"]["items"][j]["genres"].length > 0)
                        {   
                            var n = 0;
                            releases["artists"]["items"][j]["genres"].forEach(elem => {
                                if(n < 3){
                                    genres += " " + elem;
                                    n++;
                                }
                            });
                        }

                    cell.innerHTML = "<a href='artiste.html?id=" + releases["artists"]["items"][j]["id"] + "'><span style='font-size:20px'>&nbsp;" + releases["artists"]["items"][j]["name"] + "</span></a><br>";
                    cell.innerHTML += "<span style='color:rgb(130,130,130)'>&nbsp; Styles :" + genres + "<br>";
                    cell.innerHTML += "<span style='color:rgb(130,130,130)'>&nbsp; Popularité : " + releases["artists"]["items"][j]["popularity"] + "<br></span>";
                    cell.innerHTML += "<span style='color:rgb(130,130,130)'>&nbsp; Followers : " + releases["artists"]["items"][j]["followers"]["total"] + "<br></span>";
                    cell.innerHTML += "</span>";

                    if (window.matchMedia("(max-width: 600px)").matches)
                        row = tableau.insertRow(i);
                    
                    cell = row.insertCell(i);

                    cell.innerHTML = "<br>";
                    if(releases["artists"]["items"][j]["images"].length > 0)
                        cell.innerHTML += "<a href='artiste.html?id=" + releases["artists"]["items"][j]["id"] + "'><img style='max-width:250px' src='" + releases["artists"]["items"][j]["images"][1]["url"] + "'></a><br><br>";
                }
            }
        }
    });

    var requete;
    var categorie = getParameters("categorie");
    switch(categorie){
        case "nouveautes":
        document.getElementById("titre").innerHTML = "Derniers albums sortis";
        break;
        case "ambient":
            document.getElementById("titre").innerHTML = "Ambiance / Relaxation";
        break;
        case "workout":
            document.getElementById("titre").innerHTML = "Sport";
        break;
        case "hip-hop":
            document.getElementById("titre").innerHTML = "Rap";
        break;
        case "electro":
            document.getElementById("titre").innerHTML = "Electro";
        break;
        default:
            document.getElementById("titre").innerHTML = "";
    }
    if(categorie == "nouveautes")
        requete = "https://api.spotify.com/v1/browse/new-releases";
    else
        requete = "https://api.spotify.com/v1/search?q=genre:" + categorie + "&type=artist&limit=20&offset=0";
    
    xhr.open("GET", requete);
    xhr.setRequestHeader("authorization", "Bearer " + sessionStorage.getItem("active_token"));

    xhr.send(data);
    

    document.getElementById("btnmenu").addEventListener("click", affichermenu);
    
    var compteur = 0;
    function affichermenu(){
        if(compteur % 2 != 0){
            document.getElementById("recherche").style.display = "none";
            document.getElementById("navbarColor02").style.display = "none";
        }
        else
        document.getElementById("navbarColor02").style.display = "block";
        compteur ++;
    }

        const xhr2 = new XMLHttpRequest();
    xhr2.withCredentials = true;

    xhr2.addEventListener("readystatechange", function () {

        document.getElementById("recherche").innerHTML = "";
        if (this.readyState === this.DONE) {

            var releases = JSON.parse(this.responseText);
            releases["artists"]["items"].forEach(item =>{
                
                if(item["images"][2] !== undefined){
                    document.getElementById("recherche").innerHTML += "<a href='artiste?id=" + item["id"] + "'>" + item["name"] + "</a><br>";
                    //document.getElementById("recherche").innerHTML += "<img src='" + item["images"][2]["url"] + "'>" + "<br>";
                }
            });
        }

   });

   document.getElementById("txtrecherche").addEventListener("keyup", recherche);
   document.getElementById("txtrecherche").addEventListener("click", function(){
            document.getElementById("recherche").style.display = "block";
        });

        var requete;
        document.getElementById("container").addEventListener("click", function(){
            document.getElementById("recherche").style.display = "none";
        });
        
        function recherche(){
        if(document.getElementById("txtrecherche").value != "" && document.getElementById("txtrecherche").value.length > 2){
            requete = "https://api.spotify.com/v1/search?query=" + document.getElementById("txtrecherche").value + "&type=artist&limit=10";
            document.getElementById("recherche").innerHTML = "Chargement...";
                xhr2.open("GET", requete);
                xhr2.setRequestHeader("authorization", "Bearer " + sessionStorage.getItem("active_token"));
                xhr2.send(data);
        }
        else
        {
            document.getElementById("recherche").innerHTML = "";
        }
    }
</script>
</html>